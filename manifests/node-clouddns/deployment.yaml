---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
spec:
  template:
    spec:
      tolerations:
      - key: cloud.google.com/gke-preemptible
        operator: Equal
        value: "true"
        effect: NoSchedule

      containers:
      - name: external-dns
        args:
        - --source=node
        - --fqdn-template={{index .Labels "kubernetes.io/hostname"}}.pet.devmode.cloud
        - --annotation-filter=kubernetes.io/node.class=kube-pet
        - --events
        - --interval=30m
        - --zone-id-filter=devmodecloud
        - --provider=google
        - --google-project=stardust-156404
        - --registry=txt
        - --txt-owner-id=dust-nodes-usc1f
        volumeMounts:
        - name: google-cloud-key
          mountPath: /var/secrets/google
        env:
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /var/secrets/google/key.json
      volumes:
      - name: google-cloud-key
        secret:
          secretName: external-dns-gcloud-key
